
Модель
======

@@code-info
    class=jandcode.xdbm.Model
    class=jandcode.xdbm.ModelService
    class=jandcode.xdbm.ModelDef


Модель - это объект, который хранит и управляет всей информацией для работы
с определенной базой данных. Включая управление структурой базы, выполнение
запросов и др.


Описание модели
---------------

Пример описания:

@@code file=_inc/model/example1.xml

Существует 2 варианта описания модели:

* **прототип модели**. Экземпляры таких моделей
  обычно не создаются и не используются. Имя модели обычно уникальное, длинное и чаще всего
  совпадает с именем модуля, в котором модель описана.
  Можно рассматривать как "абстрактный класс модели".
* **экземпляр модели**. Экземляры таких моделей непосредственно используются
  в приложении. Такая модель обычно в приложении одна, по соглашению имеет имя `default`.
  Можно рассматривать как "экземпляр объекта".

Основное отличие экземпляра модели от прототипа модели: экземпляр модели не должен
определять никакие дополнительные объекты, влияющие на структуру модели.

Описание модели можно рассматривать как некий "пакет", в рамках которого собирается
информация об объектах модели:

@@code file=_inc/model/example2.xml

Обычно так конечно писать не нужно. Объекты модули включаются в модель посредством
тега `x-include`, который обычно указывает на файл `model/model.cfx`, который уже
и загружает все объекты этой модели.


Зависимости моделей
-------------------

Зависимости моделей реализованы посредством "включения" одной модели в другую.
Для этого используется тег `include`, где в атрибуте `name` указывается имя
включаемой модели.

Пример:

@@code file=_inc/model/example3-include.xml

При загрузке такого описание мы имеем 5 моделей, каждая из которых включает только
то, что непосредствено описано в теге `model`, в том числе перечисление
включаемых моделей.

При создании экземляра модели `jandcode.xdbm.Model` по описанию в теге `model`
происходит последовательное объединениние всех включаемых моделей в одну структуру
`Conf`, по которой уже создается экземпляр `jandcode.xdbm.Model`.

В приведенном выше примере, при создании модели для `my-model5`, происходит следующее:

* формируется список всех моделей, явно или неявно включенных в `my-model5`. В данном
  случае этот список выглядет так:
  * `my-model2` - явно включена, не имеет зависимостей
  * `my-model1` - включена не явно, через включение в `my-model4`
  * `my-model3` - включена не явно, через включение в `my-model4`
  * `my-model4` - явно включена, зависимости уже в списке
  * `my-model5` - рассматриваемая модель, последняя в списке
* создается новый пустой объект `Conf`
* в этот объект последовательно накладываются структуры всех моделей из сформированного
  списка зависимости моделей
* по объединенной структуре создается экземпляр объекта `jandcode.xdbm.Model`

При созданиеи экземпляра модели (в примере `my-model6-inst`), список зависимостей
формируется для модели, указанной в атрибуте `instance` и к этому списку добавляется
искомая модель.

В приведенном выше примере, при создании модели для `my-model6-inst` список
зависимостей будет выглядеть так:

* `my-model2`
* `my-model1`
* `my-model3`
* `my-model4`
* `my-model5`
* `my-model6-inst`


Структура базы данных
---------------------

Модель, среди прочих, объявляет объекты, которые используются при генерации
структуры физической базы данных.

При формировании физической структуры базы данных используется модульный подход,
в котором отдельные прототипы моделей могут иметь отвечать за формирование
определенного подмножества физической структуры базы данных.

За формирование структуры базы данных отвечает атрибут `dbmode`.
Возможные значения атрибута:

* `none` (или пусто, по умолчанию) - данная модель не имеет собственной физической
  структуры базы данных, хотя и может предоставлять другим моделям физические объекты
  базы данных (например таблицы).
* `module` - данная модель определяет модуль физической
  структуры базы данных, который состоит из всех моделей, начиная с нее и до первой
  модели, которая также имеет собственную структуры базы данных
* `solid` - данная модель определяет модуль физической
  структуры базы данных, который состоит из всех моделей, начиная с нее.

Пример 1:

|model  |dbmode |
| ---   | ---   |
|m1     |       |
|m2     |module |
|m3     |module |
|m4     |solid  |

В этой таблице (как и далее в примерах), модели в списке находятся в порядке,
полученном при анализе зависимостей. Т.е. этот список получен примерно из
такого описания моделей:

```xml
<root>
    <dbm>
        <model name="m1">
        </model>
        <model name="m2" dbmode="module">
            <include name="m1"/>
        </model>
        <model name="m3" dbmode="module">
            <include name="m2"/>
        </model>
        <model name="m4" dbmode="solid">
            <include name="m3"/>
        </model>

        <model name="default" instance="m4">
        </model>
    </dbm>
</root>
```

При создании базы имеем один физический модуль базы данных с именем `m4`,
в который входит `m1`, `m2`, `m3`, `m4`.

Такой вариант использования чаще всего используется на практике:
приложение имеет собственную базу данных и полностью ей управляет, модульность
структуры базы данных не требуется.

Пример 2:

|model  |dbmode |
| ---   | ---   |
|m1     |module |
|m2     |       |
|m3     |module |
|m4     |module |

При создании базы имеем 3 физических модуля базы данных:
* `m1`, в который входит `m1`
* `m3`, в который входит `m2`, `m3`
* `m4`, в который входит `m4`

Пример 3:

|model  |dbmode |
| ---   | ---   |
|m1     |module |
|m2     |       |
|m3     |solid  |
|m4     |module |

При создании базы имеем 2 физических модуля базы данных:
* `m3`, в который входит `m1`, `m2`, `m3` (`m3` объединяет в себя все, что выше его)
* `m4`, в который входит `m4`

Пример 4:

|model  |dbmode |
| ---   | ---   |
|m1     |module |
|m2     |solid  |
|m3     |solid  |
|m4     |module |

При создании базы имеем 2 физических модуля базы данных:
* `m3`, в который входит `m1`, `m2`, `m3` (`m3` объединяет в себя все, что выше его)
* `m4`, в который входит `m4`


Параметры базы данных
---------------------

Экземпляр модели может иметь только одну базу данных.
Параметры базы данных указываются в теге `<dbsource name="default"/>`.
Атрибут `dbdriver` определяет драйвер базы данных. От драйвера
зависит набор свойств, которые допустимы при конфигурировании базы данных.

Среди прочих атрибутов, у `dbsource` имеется атрибут `cfg`, в котором указывается
conf-путь, откуда брать конфигурацию базы данных модели.

По умолчанию значение атрибута `cfg="cfg/db/${modelName}"`, т.е. конфигурация
базы данных хранится в теге `cfg/db/ИМЯ-МОДЕЛИ`.

В атрибуте `cfg` можно использовать подстановки `${ATTR}`, где `ATTR` - значение
атрибута из тега `dbsource`.

На практике `dbsource` должна настраиваться только в экземплярах модели.
Кроме того, в файле `module.cfx` не нужно указывать никакие конкретные свойства
базы данных (например host, username и т.д.). Все эти настройки нужно выносить
в `app.cfx` (или `_app.cfx`).

Пример настройки базы данных модели:

@@code file=_inc/model/example4-db.xml


Конфигурация module.cfx
----------------------

### dbm/model

Описание модели.

Формат:

@@code file=_inc/model/cfx-dbm-model.xml

Атрибуты:

* `instance` - при наличии этого атрибута модель является экземпляром модели, указанной
  в значении атрибута
* `dbmode` - рижим формирования структуры базы данных. Может принимать значения
  из enum `jandcode.xdbm.DbMode`:
    * `solid` - модель имеет объединенную структуру базы данных, которая состоит
      из наложения всего, что в нее входит.
    * `module` - модель имеет собственную структуру базы данных,
      которая состоит только из объектов, объявленных в модели.
    * `none` (по умолчанию) - модель не имеет собственной структуры базы данных.


Дочерние элементы:

* `<include name="MODEL-NAME"/>` - включение зависимости от другой модели.
  Используется только в прототипах модели.
* `<dbsource name="default"/>` - свойства DbSource этой модели. Используется только в
  экземплярах модели.




