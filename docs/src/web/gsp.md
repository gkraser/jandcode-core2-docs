
GSP
===

GSP - это генератор текста по шаблонам `gsp`.

Генератор по шаблонам `gsp` принципиально устроен так же, как и другие общеупотребительные
генераторы: берется текст на некотором входном языке и на его основе генерируется текст.
Входной язык поддерживает подстановку значений переменных, операторы ветвления, циклы и
т.д.

В качестве входного языка шаблонов используется формат GSP (Groovy Server Pages) из
проекта <http://grails.org> для обеспечения нормального редактирования в IDE,
которые поддерживают `gsp`.

Синтаксис шаблонов gsp
----------------------

Текст шаблона представляет собой тело метода `onRender()` класса `jandcode.core.web.gsp.BaseGsp`
на языке `groovy`.

Парзер `gsp` преобразует текст шаблона в текст на `groovy` по следующим правилам:

* `ANYTEXT` преобразуется в `out('ANYTEXT')` _(вывести фрагмент текста)_
* `${ANYTEXT}` преобразуется в `out(ANYTEXT)` _(вывести значение выражения)_
* `<%ANYTEXT%>` преобразуется в `ANYTEXT` _(вставить фрагмент groovy-кода)_
* `<%=ANYTEXT%>` преобразуется в `out(ANYTEXT)` _(вывести значение выражения)_
* `<%--ANYTEXT--%>` преобразуется в `/*ANYTEXT*/` _(коментарий)_
* `%{--ANYTEXT--}%` преобразуется в `/*ANYTEXT*/` _(коментарий)_
* `<xx:yy/>` преобразуется в `outTag('xx/yy')` _(вызов функции outTag)_
* `<xx:yy atr="value" atr2="value2"/>` преобразуется в
  `outTag('xx/yy',atr:value,atr2:value)` _(вызов функции outTag)_
* `<xx:yy atr="value" atr2="value2"> body </xx:yy>` преобразуется в
  `outTag('xx/yy',atr:value,atr2:value) { body }` _(вызов функции outTag с closure в качестве тела)_

Каждая строка шаблона преобразуется в строку метода, что позволяет однозначно
идентифицировать место возникновения ошибки в шаблоне (в отличии от оригинального `gsp`,
где нет соответствия между сгенерированным классом и оригинальным шаблоном).

К примеру, из такого шаблона:

@@code file=_inc/app1/gsp-syntax1.gsp

генерируется вот такой класс:

@@code file=_utils/WebApp#gsp2groovy
    appConf=_inc/app1/app.cfx 
    src=_inc/app1/gsp-syntax1.gsp

обработка которого приведет к такому результату:

@@code file=_utils/WebApp#gsp2out
    appConf=_inc/app1/app.cfx 
    src=_inc/app1/gsp-syntax1.gsp

В этом примере `jc/tag1` - это `gsp` с текстом:

@@code file=_inc/app1/_tag1.gsp


Локальные переменные в шаблоне
------------------------------

Т.к. текст шаблона преобразуется в текст метода `groovy`, то определение переменной внутри
фрагментов кода, определяет локальную переменную метода:

```gsp
<%
    // локальные переменные метода шаблона
    String s = ""
    def a = []
%>
```

Для определения функций внутри шаблона изпользуются `groovy closure` (т.к. метод внутри
метода объявить нельзя):

```gsp
<%
    def pw2 = {a->
        return a*a
    }
%>
5^2 = ${pw2(5)}
```

Для определения рекурсивной функции внутри шаблона, необходимо сначала определить
переменную для функции, а потом присваивать ей `closure` (особенность `groovy`):

```gsp
<%
    def recursiveFunc
    recursiveFunc = {a->
       recursiveFunc(a+1)
    }
%>
```

